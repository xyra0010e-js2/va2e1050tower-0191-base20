<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision AI Experience</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuración Tailwind Extendida -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#050505', 
                        darkcard: '#0F0F0F',
                        galaxyPrimary: '#7c3aed', 
                        galaxySecondary: '#2dd4bf',
                        glass: 'rgba(255, 255, 255, 0.03)',
                        glassBorder: 'rgba(255, 255, 255, 0.1)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'fade-in': 'fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'float': 'float 6s ease-in-out infinite',
                        'aurora': 'aurora-flow 6s ease-in-out infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeIn: {
                            'from': { opacity: '0', transform: 'translateY(10px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-6px)' },
                        },
                        'aurora-flow': {
                            '0%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' },
                            '100%': { backgroundPosition: '0% 50%' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- Iconos -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos Base y Scrollbar */
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #050505;
            color: #e2e8f0;
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .text-gradient {
            background: linear-gradient(to right, #2dd4bf, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #2dd4bf;
            box-shadow: 0 0 15px rgba(45, 212, 191, 0.1);
            outline: none;
        }

        .bg-aurora {
            background: linear-gradient(90deg, rgba(45, 212, 191, 0.1), rgba(167, 139, 250, 0.1), rgba(244, 114, 182, 0.1));
            background-size: 200% 200%;
            animation: aurora-flow 6s ease-in-out infinite;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .bg-gemini {
            background: linear-gradient(90deg, #4b90ff, #ff5546);
            background-size: 200% 200%;
            animation: aurora-flow 4s ease-in-out infinite;
        }

        /* JSON Syntax Highlighting */
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .json-key { color: #5eead4; }
        .json-string { color: #f472b6; }
        .json-number { color: #facc15; }
        .json-boolean { color: #c084fc; }

        .video-locked { pointer-events: none !important; }
        .click-shield { position: absolute; inset: 0; z-index: 20; background: rgba(0,0,0,0); }

        .spin-slow { animation: spin 8s linear infinite; }
        .spin-paused { animation-play-state: paused; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .custom-checkbox input:checked + div { background-color: #2dd4bf; border-color: #2dd4bf; color: black; }
        
        @keyframes aurora-border-pulse {
            0% { border-color: rgba(255,255,255,0.1); box-shadow: 0 0 0 transparent; }
            50% { border-color: rgba(94, 234, 212, 0.4); box-shadow: 0 0 15px rgba(94, 234, 212, 0.1); }
            100% { border-color: rgba(255,255,255,0.1); box-shadow: 0 0 0 transparent; }
        }
        .aurora-active { animation: aurora-border-pulse 2s ease-out; }
        
        /* Chat Widget Animation */
        .chat-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Chat bold text highlight */
        .chat-highlight { color: #5eead4; font-weight: 800; text-shadow: 0 0 10px rgba(94, 234, 212, 0.3); }
    </style>
</head>
<body class="bg-[#050505] text-gray-200 min-h-screen relative overflow-x-hidden selection:bg-teal-500 selection:text-white">

    <!-- BACKGROUND BLOBS -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0 opacity-40">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-900/30 rounded-full mix-blend-screen filter blur-[100px] animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-teal-900/30 rounded-full mix-blend-screen filter blur-[100px] animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-32 left-1/3 w-96 h-96 bg-pink-900/30 rounded-full mix-blend-screen filter blur-[100px] animate-blob animation-delay-4000"></div>
    </div>

    <!-- CHAT WIDGET (GEMINI) -->
    <div id="gemini-chat-widget" class="fixed bottom-24 right-6 z-[60] hidden flex-col items-end">
        <div class="glass-panel w-80 md:w-96 h-[450px] rounded-2xl flex flex-col shadow-2xl border border-white/10 chat-slide-up bg-[#0a0a0a]/95 backdrop-blur-xl">
            <div class="p-4 border-b border-white/5 flex justify-between items-center bg-gradient-to-r from-blue-900/20 to-purple-900/20 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <i class="ph-fill ph-sparkle text-blue-400"></i>
                    <span class="font-bold text-sm text-white">Gemini Assistant</span>
                </div>
                <button onclick="toggleChat()" class="text-gray-400 hover:text-white transition-colors"><i class="ph-bold ph-x"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar text-sm">
                <div class="flex gap-2 items-start">
                    <div class="w-6 h-6 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex-shrink-0"></div>
                    <div class="bg-white/5 rounded-lg rounded-tl-none p-2 text-gray-300 border border-white/5">
                        Hola, soy tu asistente creativo. Asegúrate de configurar tu API Key para empezar.
                    </div>
                </div>
            </div>
            <div class="p-3 border-t border-white/5 flex gap-2">
                <input type="text" id="chat-input" placeholder="Pregúntame algo..." class="glass-input flex-1 rounded-xl px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500/50" onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-xl transition-colors"><i class="ph-bold ph-paper-plane-right"></i></button>
            </div>
        </div>
    </div>

    <!-- BOTÓN FLOTANTE CHAT -->
    <button onclick="toggleChat()" class="fixed bottom-6 right-24 z-50 w-12 h-12 rounded-full bg-gradient-to-tr from-blue-600 to-purple-600 text-white shadow-lg hover:scale-110 transition-transform flex items-center justify-center border border-white/20">
        <i class="ph-bold ph-chat-teardrop-text text-xl"></i>
    </button>

    <!-- NAV -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass-panel h-16 flex items-center justify-between px-6 transition-all duration-300 border-b border-white/5">
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="p-2 rounded-xl hover:bg-white/10 transition-colors text-white group">
                <i class="ph-bold ph-list text-2xl group-hover:scale-110 transition-transform"></i>
            </button>
            <div class="flex flex-col">
                <h1 id="nav-title" class="text-lg font-bold tracking-tight text-white leading-none">Vision <span class="text-teal-400">v0.9</span> Pro</h1>
                <span class="text-[10px] uppercase tracking-widest text-gray-500 font-medium">AI Experience</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button class="bg-aurora text-white text-[11px] font-bold px-6 py-2 rounded-full uppercase tracking-wide transition-all shadow-lg hover:shadow-teal-500/20 transform hover:-translate-y-0.5 hidden sm:block">Activo</button>
            <button onclick="toggleTheme()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 text-yellow-400 hover:bg-white/10 transition-all border border-white/5">
                <i id="icon-sun" class="ph-fill ph-sun text-xl hidden dark:block"></i>
                <i id="icon-moon" class="ph-fill ph-moon text-xl block dark:hidden text-indigo-600"></i>
            </button>
        </div>
    </nav>

    <!-- SIDEBAR -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-[60] hidden opacity-0 transition-opacity duration-300 backdrop-blur-sm"></div>
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-[#0a0a0a]/95 backdrop-blur-xl z-[70] transform -translate-x-full transition-transform duration-300 cubic-bezier(0.4, 0, 0.2, 1) shadow-2xl border-r border-white/5 flex flex-col">
        <div class="p-6 border-b border-white/5 flex justify-between items-center bg-gradient-to-b from-white/5 to-transparent">
            <span class="font-bold text-xl tracking-tight text-white">Menú</span>
            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-red-500 transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
        </div>
        <div class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div class="text-xs font-bold text-gray-500 uppercase tracking-widest px-3 mb-2 mt-2">Navegación</div>
            <button onclick="switchView('home')" class="w-full text-left p-3 rounded-xl flex items-center gap-3 hover:bg-white/5 text-gray-300 transition-all group border border-transparent hover:border-white/10">
                <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400 group-hover:scale-110 transition-transform"><i class="ph-fill ph-house text-lg"></i></div>
                <span class="font-medium group-hover:translate-x-1 transition-transform">Inicio</span>
            </button>
            <button onclick="switchView('gallery')" class="w-full text-left p-3 rounded-xl flex items-center gap-3 hover:bg-white/5 text-gray-300 transition-all group border border-transparent hover:border-white/10">
                <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-400 group-hover:scale-110 transition-transform"><i class="ph-fill ph-images text-lg"></i></div>
                <span class="font-medium group-hover:translate-x-1 transition-transform">Galería</span>
            </button>
            <button onclick="switchView('guide')" class="w-full text-left p-3 rounded-xl flex items-center gap-3 hover:bg-white/5 text-gray-300 transition-all group border border-transparent hover:border-white/10">
                <div class="w-8 h-8 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-400 group-hover:scale-110 transition-transform"><i class="ph-fill ph-book-open text-lg"></i></div>
                <span class="font-medium group-hover:translate-x-1 transition-transform">Guía de Modelos</span>
            </button>
            <div class="h-px bg-white/10 my-4 mx-3"></div>
            <div class="text-xs font-bold text-gray-400 uppercase tracking-widest px-3 mb-2">Herramientas AI</div>
            
            <button onclick="switchView('eraser')" class="w-full text-left p-3 rounded-xl flex items-center gap-3 hover:bg-white/5 text-gray-300 transition-all group border border-transparent hover:border-white/10">
                <div class="w-8 h-8 rounded-lg bg-red-500/10 flex items-center justify-center text-red-400 group-hover:scale-110 transition-transform"><i class="ph-fill ph-eraser text-lg"></i></div>
                <span class="font-medium group-hover:translate-x-1 transition-transform">Borrador Mágico</span>
            </button>
            
            <!-- NUEVO BOTÓN SORA -->
            <button onclick="switchView('sora')" class="w-full text-left p-3 rounded-xl flex items-center gap-3 hover:bg-white/5 text-gray-300 transition-all group border border-transparent hover:border-white/10">
                <div class="w-8 h-8 rounded-lg bg-pink-500/10 flex items-center justify-center text-pink-400 group-hover:scale-110 transition-transform"><i class="ph-fill ph-film-slate text-lg"></i></div>
                <span class="font-medium group-hover:translate-x-1 transition-transform">Sora2Prompt</span>
            </button>

            <button onclick="switchView('vision')" class="w-full text-left p-3 rounded-xl flex items-center gap-3 hover:bg-white/5 text-gray-300 transition-all group border border-transparent hover:border-white/10">
                <div class="w-8 h-8 rounded-lg bg-teal-500/10 flex items-center justify-center text-teal-400 group-hover:scale-110 transition-transform"><i class="ph-fill ph-magic-wand text-lg"></i></div>
                <span class="font-medium group-hover:translate-x-1 transition-transform">Vision Prompt</span>
            </button>
            <button onclick="switchView('json')" class="w-full text-left p-3 rounded-xl flex items-center gap-3 hover:bg-white/5 text-gray-300 transition-all group border border-transparent hover:border-white/10">
                <div class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center text-amber-400 group-hover:scale-110 transition-transform"><i class="ph-fill ph-code text-lg"></i></div>
                <span class="font-medium group-hover:translate-x-1 transition-transform">Json Prompt</span>
            </button>
            
            <div class="h-px bg-white/10 my-4 mx-3"></div>
            <!-- BOTÓN CONFIGURACIÓN -->
            <button onclick="switchView('settings')" class="w-full text-left p-3 rounded-xl flex items-center gap-3 hover:bg-white/5 text-gray-300 transition-all group border border-transparent hover:border-white/10">
                <div class="w-8 h-8 rounded-lg bg-gray-500/10 flex items-center justify-center text-gray-400 group-hover:scale-110 transition-transform"><i class="ph-fill ph-gear text-lg"></i></div>
                <span class="font-medium group-hover:translate-x-1 transition-transform">Configuración</span>
            </button>
        </div>
        <div class="p-4 border-t border-white/5">
            <div class="flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-white/5">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-teal-400 to-blue-500 flex items-center justify-center text-white font-bold text-sm shadow-lg">G</div>
                <div>
                    <p class="text-xs font-bold text-white">Usuario Invitado</p>
                    <p class="text-[10px] text-gray-500">Modo Anónimo</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- VISTA 1: INICIO -->
    <div id="view-home" class="animate-fade-in relative z-10 pt-16">
        <section class="relative w-full h-[85vh] overflow-hidden flex flex-col items-center justify-center text-center">
            <div class="absolute inset-0 bg-gradient-to-b from-[#0a0a0a] via-black to-black z-0"></div>
            <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-blue-900/20 via-transparent to-transparent opacity-60 z-0"></div>
            
            <div class="relative z-10 px-6 mt-10 md:mt-0 flex flex-col items-center max-w-4xl mx-auto">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-teal-500/30 bg-teal-500/10 text-teal-300 text-xs font-medium uppercase tracking-wider mb-6 animate-fade-in backdrop-blur-md">
                    <span class="w-2 h-2 rounded-full bg-teal-400 animate-pulse"></span> Activo
                </div>
                <h2 class="text-5xl md:text-7xl font-extrabold mb-4 tracking-tighter text-white leading-tight drop-shadow-2xl">
                    El inicio es <br/>
                    <span class="text-gradient">Vision v0.9Pro </span>
                </h2>
                <p class="text-gray-400 text-lg md:text-xl max-w-xl mb-10 leading-relaxed font-light">
                    Experimenta Vision v0.9Pro Crea, edita y visualiza.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
                    <button class="bg-white text-black font-bold py-3 px-8 rounded-full hover:bg-gray-200 transition-colors shadow-[0_0_30px_rgba(255,255,255,0.1)]">
                        Ver Video
                    </button>
                    <button class="glass-panel text-white font-bold py-3 px-8 rounded-full hover:bg-white/10 transition-colors">
                        Guía
                    </button>
                </div>
            </div>
            
            <div class="absolute bottom-[-10%] md:bottom-[-20%] left-1/2 transform -translate-x-1/2 w-[70%] max-w-[600px] pointer-events-none opacity-60 mix-blend-lighten animate-float">
               <div class="w-full aspect-square rounded-full bg-gradient-to-t from-blue-600/20 via-purple-600/10 to-transparent filter blur-[80px]"></div>
            </div>
        </section>

        <section class="bg-black py-16 px-4 border-t border-white/5 relative z-20">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-end mb-8 px-2">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2 tracking-tight">Explora con Vision</h2>
                        <p class="text-gray-500 text-sm">Contenido destacado de Vision v0.9 Pro</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('video-scroll-container').scrollBy({left:-300, behavior:'smooth'})" class="p-2 rounded-full border border-white/10 hover:bg-white/10 text-white transition-colors"><i class="ph-bold ph-caret-left"></i></button>
                        <button onclick="document.getElementById('video-scroll-container').scrollBy({left:300, behavior:'smooth'})" class="p-2 rounded-full border border-white/10 hover:bg-white/10 text-white transition-colors"><i class="ph-bold ph-caret-right"></i></button>
                    </div>
                </div>
                <div class="relative group">
                    <div id="video-scroll-container" class="flex overflow-x-auto gap-5 pb-8 px-2 hide-scrollbar snap-x snap-mandatory scroll-smooth">
                        <!-- JS Llenará esto -->
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- VISTA 2: GALERIA -->
    <div id="view-gallery" class="hidden pt-24 px-4 min-h-screen bg-[#050505]">
        <header class="mb-12 text-center max-w-4xl mx-auto animate-fade-in">
            <h2 class="text-3xl md:text-5xl font-bold text-white mb-4 tracking-tight">Galería Multimedia</h2>
            <p class="text-gray-400 max-w-xl mx-auto">Colección curada de fotos y videos procesados con el motor gráfico de Galaxy.</p>
        </header>
        <div id="items-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-7xl mx-auto pb-24 px-2">
            <div class="glass-panel rounded-2xl h-80 animate-pulse"></div>
            <div class="glass-panel rounded-2xl h-80 animate-pulse"></div>
            <div class="glass-panel rounded-2xl h-80 animate-pulse"></div>
        </div>
        
        <!-- Music Widget -->
        <div id="music-widget" class="fixed bottom-6 right-6 z-50 hidden animate-fade-in">
            <div class="relative group">
                <div class="absolute -top-32 right-0 glass-panel p-4 rounded-xl w-64 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-all duration-300 transform translate-y-4 group-hover:translate-y-0">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Playlist</h4>
                    <div id="playlist-container" class="max-h-40 overflow-y-auto space-y-1 custom-scrollbar"></div>
                </div>
                <button onclick="toggleMusicMenu()" class="relative z-10">
                    <div id="vinyl-record" class="w-16 h-16 bg-black rounded-full border-4 border-[#1a1a1a] shadow-[0_0_30px_rgba(0,0,0,0.5)] flex items-center justify-center spin-slow spin-paused relative overflow-hidden">
                        <div class="absolute inset-0 bg-[conic-gradient(transparent,rgba(255,255,255,0.1),transparent)]"></div>
                        <i class="ph-fill ph-music-notes text-teal-400 text-xl relative z-20"></i>
                        <div class="absolute w-4 h-4 bg-[#1a1a1a] rounded-full z-10 border border-[#333]"></div>
                    </div>
                </button>
            </div>
            <audio id="audio-player"></audio>
        </div>
    </div>

    <!-- VISTA INTEGRADA: GUIA -->
    <div id="view-guide" class="hidden pt-16 min-h-screen w-full bg-[#050505] relative z-10 flex flex-col">
        <iframe src="guia.html" class="flex-1 w-full border-none h-[calc(100vh-64px)]" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe>
    </div>

    <!-- VISTA: BORRADOR -->
    <div id="view-eraser" class="hidden pt-16 h-screen w-full bg-black relative z-10 flex flex-col">
        <iframe src="borrador.html" class="flex-1 w-full border-none" allow="camera; photos"></iframe>
    </div>
    
    <!-- NUEVA VISTA: SORA -->
    <div id="view-sora" class="hidden pt-16 h-screen w-full bg-black relative z-10 flex flex-col">
        <iframe src="Sora2Prompt.html" class="flex-1 w-full border-none" allow="clipboard-read; clipboard-write"></iframe>
    </div>
    
    <!-- NUEVA VISTA: CONFIGURACIÓN -->
    <div id="view-settings" class="hidden pt-24 px-4 min-h-screen bg-[#050505]">
        <div class="max-w-2xl mx-auto animate-fade-in space-y-8">
            <div class="text-center mb-10">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white/5 mb-6 border border-white/10">
                    <i class="ph-fill ph-gear text-3xl text-gray-300"></i>
                </div>
                <h2 class="text-3xl md:text-4xl font-bold text-white tracking-tight">Configuración</h2>
                <p class="text-gray-400 mt-2">Gestiona tus claves de acceso y preferencias.</p>
            </div>
            
            <div class="glass-panel p-8 rounded-3xl shadow-2xl backdrop-blur-xl border border-white/10 space-y-6">
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                         <label class="text-sm font-bold text-teal-400 uppercase tracking-widest flex items-center gap-2">
                            <i class="ph-bold ph-key"></i> Gemini API Key
                        </label>
                        <span id="api-status" class="text-[10px] uppercase font-bold text-gray-500 px-2 py-1 rounded bg-white/5">Sin configurar</span>
                    </div>
                    <p class="text-xs text-gray-500 leading-relaxed">
                        Ingresa tu API Key de Google Gemini para habilitar las funciones de inteligencia artificial. 
                        Esta clave se guardará únicamente en el almacenamiento local de tu navegador (<span class="text-teal-500 font-mono">localStorage</span>) y nunca será enviada a servidores externos de la aplicación.
                    </p>
                    
                    <div class="relative group">
                        <input type="password" id="settings-api-key" placeholder="Pegar API Key aquí (AIzaSy...)" 
                            class="glass-input w-full rounded-xl py-4 pl-4 pr-12 text-sm text-white focus:ring-1 focus:ring-teal-500/50 font-mono tracking-wide placeholder-gray-600 transition-all">
                        <button onclick="toggleKeyVisibility()" class="absolute right-4 top-4 text-gray-500 hover:text-white transition-colors">
                            <i id="eye-icon" class="ph-bold ph-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-white/5">
                    <button onclick="saveSettings()" class="w-full bg-gradient-to-r from-teal-600 to-blue-600 hover:from-teal-500 hover:to-blue-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition-all flex justify-center items-center gap-2">
                        <i class="ph-bold ph-floppy-disk"></i> Guardar Configuración
                    </button>
                </div>
            </div>
            
            <div class="text-center">
                 <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-gray-500 hover:text-white underline decoration-gray-700 hover:decoration-white transition-colors">
                    ¿No tienes una API Key? Consíguela aquí
                </a>
            </div>
        </div>
    </div>

    <!-- VISTA 3: VISION PROMPT (Mejorado) -->
    <div id="view-vision" class="hidden pt-24 px-4 min-h-screen bg-[#050505] relative">
        <div class="max-w-7xl mx-auto grid lg:grid-cols-12 gap-8 pb-20">
             <div class="lg:col-span-7 space-y-8 animate-fade-in">
                 <div class="text-left mb-6">
                    <h2 id="vision-main-title" class="text-4xl font-bold text-white tracking-tight">Vision Prompt</h2>
                    <p id="vision-main-desc" class="text-gray-400 mt-2">Construye descripciones detalladas para generación de imágenes.</p>
                 </div>
                 
                 <div id="vision-controls-box" class="glass-panel p-8 rounded-3xl space-y-8 shadow-2xl backdrop-blur-xl">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-teal-500 uppercase tracking-wider ml-1">Formato</label>
                            <div class="relative">
                                <i class="ph-bold ph-paint-brush absolute left-3 top-3.5 text-gray-500"></i>
                                <select id="p-formats" class="glass-input w-full rounded-xl py-3 pl-10 pr-4 text-sm text-gray-200 appearance-none cursor-pointer"><option value="">Ninguno</option></select>
                                <i class="ph-bold ph-caret-down absolute right-3 top-3.5 text-gray-500 pointer-events-none"></i>
                            </div>
                        </div>
                        <div class="space-y-2 relative">
                            <label class="text-xs font-bold text-teal-500 uppercase tracking-wider ml-1">Personajes</label>
                            <div onclick="toggleSubjectDropdown(event)" class="glass-input w-full rounded-xl py-3 px-4 text-sm text-gray-200 cursor-pointer flex justify-between items-center hover:border-teal-500/50">
                                <span id="subjects-text" class="truncate text-gray-500">Seleccionar...</span>
                                <i class="ph-bold ph-caret-down text-gray-500"></i>
                            </div>
                            <div id="subjects-dropdown" class="absolute top-full left-0 w-full mt-2 bg-[#151515] border border-white/10 rounded-xl shadow-2xl z-50 hidden max-h-60 overflow-y-auto custom-scrollbar">
                                <p class="text-xs text-center p-4 text-gray-500">Cargando datos...</p>
                            </div>
                            <div id="selected-subjects-tags" class="flex flex-wrap gap-2 mt-3 min-h-[30px]"></div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-indigo-400 uppercase tracking-wider ml-1">Concepto Central</label>
                        <textarea id="p-concept" class="glass-input w-full rounded-2xl p-4 text-sm text-gray-200 h-28 resize-none focus:ring-1 focus:ring-indigo-500/50 placeholder-gray-500" placeholder="Describe la escena, acción o elementos principales..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-5">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Estilo Artístico</label>
                            <select id="p-styles" class="glass-input w-full rounded-lg p-2.5 text-xs text-gray-300"><option value="">none</option></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Iluminación</label>
                            <select id="p-lighting" class="glass-input w-full rounded-lg p-2.5 text-xs text-gray-300"><option value="">none</option></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Cámara</label>
                            <select id="p-camera" class="glass-input w-full rounded-lg p-2.5 text-xs text-gray-300"><option value="">none</option></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Aspect Ratio</label>
                            <select id="p-ratios" class="glass-input w-full rounded-lg p-2.5 text-xs text-gray-300"><option value="">none</option></select>
                        </div>
                    </div>
                    <!-- Botones de Acción (Vision Prompt) -->
                    <div class="flex gap-4">
                        <button onclick="assemblePrompt()" class="flex-1 bg-white/5 hover:bg-white/10 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-[0.98] transition-all flex justify-center items-center gap-2 border border-white/10">
                            <i class="ph-bold ph-pencil-simple"></i> Ensamblar
                        </button>
                        <button id="btn-gemini-vision" onclick="enhanceWithGemini()" class="flex-1 bg-gemini text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-blue-500/30 transform active:scale-[0.98] transition-all flex justify-center items-center gap-2 border-0">
                            <i class="ph-fill ph-sparkle"></i> Enhance AI
                        </button>
                    </div>
                 </div>
             </div>
             
             <!-- Panel Resultado -->
             <div class="lg:col-span-5 relative">
                 <div class="sticky top-24">
                     <div class="glass-panel rounded-3xl overflow-hidden shadow-2xl flex flex-col h-[500px] border border-white/10">
                        <div class="bg-black/20 p-4 border-b border-white/5 flex justify-between items-center backdrop-blur-md">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Resultado</span>
                            <button onclick="copyPrompt()" class="text-xs bg-white/5 hover:bg-white/10 text-white px-3 py-1.5 rounded-lg transition-colors flex items-center gap-2 font-medium border border-white/5">
                                <i class="ph-bold ph-copy"></i> Copiar
                            </button>
                        </div>
                        <div class="relative flex-1 p-6">
                            <div id="prompt-output" class="text-sm md:text-base text-teal-300 font-mono leading-relaxed h-full overflow-y-auto custom-scrollbar break-words">
                                <span class="text-gray-600 italic">// El prompt generado aparecerá aquí...</span>
                            </div>
                        </div>
                     </div>
                 </div>
             </div>
        </div>
    </div>

    <!-- VISTA 4: VISION JSON PROMPT (3 Modos + Random) -->
    <div id="view-json" class="hidden pt-24 px-4 min-h-screen bg-[#050505]">
        <div class="max-w-7xl mx-auto pb-24">
            <header class="mb-10 flex flex-col md:flex-row justify-between items-end border-b border-white/5 pb-8 animate-fade-in">
                <div>
                    <h2 class="text-3xl md:text-5xl font-bold text-white tracking-tight mb-2">Json Script</h2>
                    <p class="text-gray-400">Generador de escenas estructuradas para animación.</p>
                </div>
                <div class="flex gap-2 mt-4 md:mt-0 flex-wrap justify-end">
                    <button id="btn-ai-dialogue" onclick="improveJsonDialogues()" class="bg-blue-600/80 hover:bg-blue-500 text-white font-bold py-2 px-5 rounded-xl shadow-lg border border-blue-500/20 active:scale-95 transition-all flex items-center gap-2 text-sm">
                        <i class="ph-fill ph-chats"></i> Mejorar Diálogos
                    </button>
                    <button onclick="generateJson()" class="bg-amber-600/80 hover:bg-amber-500 text-white font-bold py-2 px-5 rounded-xl shadow-lg border border-amber-500/20 active:scale-95 transition-all flex items-center gap-2 text-sm">
                        <i class="ph-bold ph-code"></i> Generar Manual
                    </button>
                </div>
            </header>

            <div class="grid lg:grid-cols-12 gap-8">
                <div class="lg:col-span-7 space-y-6 animate-fade-in">
                    <!-- Config Escena -->
                    <div class="glass-panel p-6 rounded-2xl shadow-sm">
                        <h3 class="text-xs font-bold text-amber-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i class="ph-fill ph-film-strip text-lg"></i> Configuración de Escena
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Lugar</label>
                                <input type="text" id="j-scene" placeholder="Ej: Laboratorio futurista..." class="glass-input w-full rounded-lg p-3 text-sm text-white placeholder-gray-600">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Estilo Visual</label>
                                <select id="j-style" class="glass-input w-full rounded-lg p-3 text-sm text-white">
                                    <option value="none">Seleccionar...</option>
                                    <option value="Realista">Realista</option>
                                    <option value="Pixar">Pixar 3D</option>
                                    <option value="Anime">Anime</option>
                                    <option value="Cinematic">Cinemático</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Dirección de Cámara (RESTAURADO) -->
                    <div class="glass-panel p-6 rounded-2xl shadow-sm">
                        <h3 class="text-xs font-bold text-blue-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i class="ph-fill ph-video-camera text-lg"></i> Dirección de Cámara
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Movimiento</label>
                                <select id="j-cam-mov" class="glass-input w-full rounded-lg p-3 text-sm text-white"><option value="none">none</option></select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Encuadre</label>
                                <select id="j-cam-frame" class="glass-input w-full rounded-lg p-3 text-sm text-white"><option value="none">none</option></select>
                            </div>
                        </div>
                    </div>

                    <!-- Reparto -->
                    <div class="glass-panel p-6 rounded-2xl shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xs font-bold text-green-500 uppercase tracking-widest flex items-center gap-2">
                                <i class="ph-fill ph-users text-lg"></i> Reparto
                            </h3>
                            <button onclick="addJsonCharacter()" class="text-xs bg-green-500/10 text-green-400 hover:bg-green-500 hover:text-white px-3 py-1.5 rounded-lg transition-colors border border-green-500/20 font-bold flex items-center gap-1">
                                <i class="ph-bold ph-plus"></i> Agregar
                            </button>
                        </div>
                        
                        <div id="json-chars-container" class="space-y-4">
                            <div id="empty-chars-msg" class="text-center py-8 text-gray-500 text-sm border-2 border-dashed border-white/5 rounded-xl">
                                No hay personajes agregados.
                            </div>
                        </div>
                    </div>

                    <!-- Botón Generar Random abajo -->
                     <button id="btn-random-json" onclick="generateRandomJson()" class="w-full bg-gradient-to-r from-purple-900/50 to-pink-900/50 hover:from-purple-800/60 hover:to-pink-800/60 text-white font-bold py-4 rounded-xl border border-white/10 active:scale-[0.98] transition-all flex justify-center items-center gap-2 shadow-lg">
                        <i class="ph-fill ph-dice-five text-xl"></i> Generar Script Totalmente Random
                    </button>
                </div>

                <div class="lg:col-span-5">
                    <div class="sticky top-24 glass-panel rounded-2xl shadow-2xl overflow-hidden flex flex-col h-[600px] border border-white/10">
                        <div class="bg-black/20 p-3 border-b border-white/5 flex justify-between items-center px-4 backdrop-blur-md">
                            <span class="text-[10px] font-mono text-gray-500">output.json</span>
                            <button onclick="copyJson()" class="text-xs hover:text-white text-gray-400 transition-colors"><i class="ph-bold ph-copy"></i></button>
                        </div>
                        <pre id="json-output" class="flex-1 p-5 overflow-auto font-mono text-xs md:text-sm text-gray-300 leading-relaxed custom-scrollbar bg-transparent">
// El script generado aparecerá aquí...
                        </pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDr490X-m0dw5wnQaTmyhjjzd1TRJgEMcs", authDomain: "mi-web-app-f0523.firebaseapp.com", projectId: "mi-web-app-f0523", storageBucket: "mi-web-app-f0523.firebasestorage.app", messagingSenderId: "509336040232", appId: "1:509336040232:web:b41a777c6dd63ba350d61d", measurementId: "G-1BFT6DZEV5" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        signInAnonymously(auth).then(()=>console.log("Conectado")).catch(console.error);

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; };

        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        window.toggleSidebar = () => { 
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            if(isOpen) { sidebar.classList.add('-translate-x-full'); overlay.classList.remove('opacity-100'); setTimeout(() => overlay.classList.add('hidden'), 300); } 
            else { overlay.classList.remove('hidden'); void overlay.offsetWidth; overlay.classList.add('opacity-100'); sidebar.classList.remove('-translate-x-full'); }
        };
        
        window.switchView = (viewName) => {
            ['home', 'gallery', 'vision', 'json', 'eraser', 'guide', 'settings', 'sora'].forEach(v => { 
                const el = document.getElementById(`view-${v}`);
                if(el) { el.classList.add('hidden'); el.classList.remove('animate-fade-in'); }
            });
            const target = document.getElementById(`view-${viewName}`); 
            if(target) { target.classList.remove('hidden'); void target.offsetWidth; target.classList.add('animate-fade-in'); }
            if(window.innerWidth < 1024) toggleSidebar();
        };

        /* -----------------------------------------------------
           API KEY MANAGEMENT & GEMINI LOGIC
           ----------------------------------------------------- */
        
        // 1. Funciones de Configuración Local
        const API_STORAGE_KEY = 'gemini_api_key_local';

        window.toggleKeyVisibility = () => {
            const input = document.getElementById('settings-api-key');
            const icon = document.getElementById('eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'ph-bold ph-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'ph-bold ph-eye';
            }
        };

        window.saveSettings = () => {
            const input = document.getElementById('settings-api-key');
            const key = input.value.trim();
            if (key) {
                localStorage.setItem(API_STORAGE_KEY, key);
                updateApiStatusUI();
                alert("Configuración guardada correctamente.");
            } else {
                alert("Por favor ingresa una API Key válida.");
            }
        };

        function getStoredApiKey() {
            return localStorage.getItem(API_STORAGE_KEY);
        }

        function updateApiStatusUI() {
            const statusEl = document.getElementById('api-status');
            const inputEl = document.getElementById('settings-api-key');
            const key = getStoredApiKey();
            
            if (key) {
                statusEl.innerText = "Configurado";
                statusEl.classList.remove('text-gray-500', 'bg-white/5');
                statusEl.classList.add('text-teal-400', 'bg-teal-500/10', 'border', 'border-teal-500/20');
                inputEl.value = key; // Rellenar input al cargar
            } else {
                statusEl.innerText = "Sin configurar";
                statusEl.className = "text-[10px] uppercase font-bold text-gray-500 px-2 py-1 rounded bg-white/5";
            }
        }

        // Cargar estado inicial
        updateApiStatusUI();


        // 2. Función de Llamada IA (Actualizada para usar LocalStorage)
        async function callGeminiAPI(userPrompt) {
            const apiKey = getStoredApiKey();
            
            // Validación de seguridad antes de llamar
            if (!apiKey) {
                if(confirm("Se requiere una API Key de Gemini para usar esta función. ¿Deseas configurarla ahora?")) {
                    switchView('settings');
                }
                return "Error: API Key no configurada.";
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "Error en la petición");
                }

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error en la respuesta de Gemini.";
            } catch (error) {
                console.error("Gemini Error:", error);
                return `Error de conexión: ${error.message}. Verifica tu API Key.`;
            }
        }

        // --- FEATURE 1: Vision Prompt Enhancer (RESPETA LO MANUAL) ---
        window.enhanceWithGemini = async () => {
            // 1. Primero ensamblamos lo que el usuario ha seleccionado manualmente
            assemblePrompt(); 
            
            const currentPrompt = document.getElementById('prompt-output').innerText;
            const btn = document.getElementById('btn-gemini-vision');
            const output = document.getElementById('prompt-output');

            if (!currentPrompt || currentPrompt.includes("// El prompt")) {
                alert("Primero ensambla un prompt base.");
                return;
            }

            // UI Loading
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin"></i> Mejorando...`;
            btn.disabled = true;

            const promptForGemini = `
                Act as a professional prompt enhancer for Stable Diffusion.
                I have this manually assembled prompt: "${currentPrompt}".
                
                YOUR TASK:
                1. KEEP all the specific subjects, aspect ratios, and format tags exactly as they are. Do NOT remove them.
                2. ONLY add high-quality artistic descriptors, lighting details (e.g., volumetric lighting, cinematic), and texture details to improve the quality to 8k.
                3. Do NOT change the core concept or the characters selected.
                
                Output ONLY the final enhanced prompt text.
            `;

            const result = await callGeminiAPI(promptForGemini);
            // Verificar si devolvió error de API Key
            if(result.startsWith("Error:")) {
                output.innerText = "// Error: Configura tu API Key";
            } else {
                output.innerText = result.trim();
                // Animation
                const box = document.getElementById('vision-controls-box'); 
                box.classList.remove('aurora-active'); void box.offsetWidth; box.classList.add('aurora-active');
            }

            // Reset UI
            btn.innerHTML = originalText;
            btn.disabled = false;
        };

        // --- FEATURE 2: Json Script - Mejorar Diálogos (RESPETA PERSONAJES + 7seg Rule) ---
        function getJsonDataFromUI() {
            const scene = document.getElementById('j-scene').value;
            const style = document.getElementById('j-style').value;
            // Get camera values
            const camMov = document.getElementById('j-cam-mov')?.value || "none";
            const camFrame = document.getElementById('j-cam-frame')?.value || "none";

            const charCards = document.querySelectorAll('[id^="char-card-"]');
            const characters = Array.from(charCards).map(card => ({
                name: card.querySelector('.j-char-name').value, 
                description: card.querySelector('.j-char-desc').value, 
                dialogue: card.querySelector('.j-char-dial').value,
                voice: { 
                    tone: card.querySelector('.j-char-tone').value, 
                    accent: card.querySelector('.j-char-acc').value, 
                    language: card.querySelector('.j-char-lang').value, 
                    action: card.querySelector('.j-char-act').value 
                }
            }));
            return { scene, style, characters, camera: { movement: camMov, framing: camFrame } };
        }

        window.improveJsonDialogues = async () => {
            const currentData = getJsonDataFromUI();
            const numChars = currentData.characters.length;
            
            if (numChars === 0) {
                alert("Agrega al menos un personaje manualmente primero.");
                return;
            }

            const btn = document.getElementById('btn-ai-dialogue');
            const output = document.getElementById('json-output');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin"></i> Mejorando...`;
            btn.disabled = true;

            const promptForGemini = `
                I have a JSON script for an animation. 
                Scene: "${currentData.scene || 'General scene'}".
                Style: "${currentData.style}".
                
                Current Characters Data: ${JSON.stringify(currentData.characters)}
                Camera Data: ${JSON.stringify(currentData.camera)}
                
                CRITICAL INSTRUCTION ON DURATION:
                The TOTAL duration of dialogues for all characters combined must be roughly 7 seconds of spoken time.
                - If 1 character: The dialogue should be roughly 7 seconds long.
                - If 2 characters: Divide the time (~3.5s each).
                - If ${numChars} characters: Divide ~7s by ${numChars} for each dialogue length.
                
                TASK:
                1. KEEP the character names and descriptions EXACTLY as provided. Do NOT add new characters.
                2. REWRITE the 'dialogue' fields to be more engaging but strictly adhering to the time limit calculated above.
                3. Update the 'voice.tone' or 'voice.action' if necessary.
                4. KEEP the camera settings exactly as provided.
                
                Output ONLY valid JSON.
            `;

            let result = await callGeminiAPI(promptForGemini);
            
            if(result.startsWith("Error:")) {
                 output.innerText = "// Error: " + result;
            } else {
                result = result.replace(/```json/g, '').replace(/```/g, '').trim();
                try {
                    const parsed = JSON.parse(result);
                    // Actualizar UI (Textareas)
                    const charCards = document.querySelectorAll('[id^="char-card-"]');
                    if (parsed.characters && parsed.characters.length === charCards.length) {
                        parsed.characters.forEach((char, index) => {
                            const card = charCards[index];
                            card.querySelector('.j-char-dial').value = char.dialogue;
                            if(char.voice?.action) card.querySelector('.j-char-act').value = char.voice.action;
                        });
                    }
                    
                    const prettyJson = JSON.stringify(parsed, null, 2);
                    output.innerText = prettyJson;
                } catch (e) {
                    console.error(e);
                    output.innerText = "Error procesando la respuesta de la IA.\n" + result;
                }
            }
            btn.innerHTML = originalText;
            btn.disabled = false;
        };

        // --- FEATURE 3: Random Json Generator (7seg Rule + SPANISH ONLY) ---
        window.generateRandomJson = async () => {
            const btn = document.getElementById('btn-random-json');
            const output = document.getElementById('json-output');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin"></i> Creando Magia...`;
            btn.disabled = true;

            const promptForGemini = `
                Generate a COMPLETELY RANDOM and creative JSON script for a short 3D animation scene and realistic scene.
    
    IMPORTANT: FORCE VARIETY IN GENRE. Do NOT default to Sci-Fi or Space.
    Please pick one randomly from this list: 
    - Medieval hurmo animation Fantasy (Knights, Dragons, Castles)
    - Modern Slice of Life (Beach, Supermarket, school, forest, among many casual places)
    - Vlog irl
    - Adventure (Jungle, Desert, Mountains)
    - Story / Mystery
    - Comedy / Humor
    - Mexican or humorous scenarios or sketches 
    
    CRITICAL INSTRUCTIONS:
    1. The total spoken dialogue in the scene MUST be approximately 7 seconds long total. Split this time between the generated characters.
    2. The 'dialogue' text MUST BE IN SPANISH  (Español). This is mandatory.
                
                Structure:
                {
                  "scene": "Creative description",
                  "style": "Visual style",
                  "camera": { "movement": "...", "framing": "..." },
                  "characters": [
                    { "name": "Unique Name", "description": "...", "dialogue": "Spanish dialogue here...", "voice": {...} },
                    { "name": "Unique Name 2", "description": "...", "dialogue": "Spanish dialogue here...", "voice": {...} }
                  ]
                }
                Output ONLY valid JSON.
            `;

            let result = await callGeminiAPI(promptForGemini);
             if(result.startsWith("Error:")) {
                 output.innerText = "// Error: " + result;
            } else {
                result = result.replace(/```json/g, '').replace(/```/g, '').trim();
                output.innerText = result;
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        };

        // --- FEATURE 4: Chat Widget Logic (Estilo) ---
        window.toggleChat = () => {
            const widget = document.getElementById('gemini-chat-widget');
            const isHidden = widget.classList.contains('hidden');
            if (isHidden) {
                widget.classList.remove('hidden');
                widget.classList.add('flex');
            } else {
                widget.classList.add('hidden');
                widget.classList.remove('flex');
            }
        };
        
        // Helper para formato estético
        function formatChatText(text) {
             // Reemplaza **texto** y *texto* por un span con clase aesthetic
             return text
                .replace(/\*\*(.*?)\*\*/g, '<span class="chat-highlight">$1</span>')
                .replace(/\*(.*?)\*/g, '<span class="chat-highlight">$1</span>');
        }

        window.sendChatMessage = async () => {
            const input = document.getElementById('chat-input');
            const container = document.getElementById('chat-messages');
            const text = input.value.trim();
            
            if (!text) return;

            // User Message
            const userMsg = document.createElement('div');
            userMsg.className = "flex gap-2 items-start flex-row-reverse animate-fade-in";
            userMsg.innerHTML = `<div class="w-6 h-6 rounded-full bg-gray-500 flex-shrink-0"></div><div class="bg-blue-600 rounded-lg rounded-tr-none p-2 text-white text-sm">${text}</div>`;
            container.appendChild(userMsg);
            input.value = '';
            container.scrollTop = container.scrollHeight;

            // AI Loading
            const loadingMsg = document.createElement('div');
            loadingMsg.id = "chat-loading";
            loadingMsg.className = "flex gap-2 items-start animate-fade-in";
            loadingMsg.innerHTML = `<div class="w-6 h-6 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex-shrink-0"></div><div class="bg-white/5 rounded-lg rounded-tl-none p-2 text-gray-400 text-xs italic border border-white/5">Escribiendo...</div>`;
            container.appendChild(loadingMsg);
            container.scrollTop = container.scrollHeight;

            // Call API with formatting instruction
            const responseText = await callGeminiAPI("Context: Creative AI assistant for Vision AI app. Instructions: Keep answers concise. Use *asterisks* to highlight key words or important concepts to make it look aesthetic. User says: " + text);
            
            document.getElementById('chat-loading').remove();
            
            // AI Response with formatting
            const formattedText = formatChatText(responseText);
            const aiMsg = document.createElement('div');
            aiMsg.className = "flex gap-2 items-start animate-fade-in";
            aiMsg.innerHTML = `<div class="w-6 h-6 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex-shrink-0"></div><div class="bg-white/5 rounded-lg rounded-tl-none p-2 text-gray-300 text-sm border border-white/5">${formattedText}</div>`;
            container.appendChild(aiMsg);
            container.scrollTop = container.scrollHeight;
        };

        // ... JS LOGIC ANTIGUO (RESTO DEL CÓDIGO JS SE MANTIENE PARA FIREBASE Y CARGA DE DATOS) ...
        let selectedSubjects = [];
        let allSubjectsData = [];
        window.toggleSubjectDropdown = (event) => { event.stopPropagation(); document.getElementById('subjects-dropdown').classList.toggle('hidden'); };
        document.addEventListener('click', (e) => {
            const dd = document.getElementById('subjects-dropdown');
            const btn = document.getElementById('subjects-text')?.parentElement;
            if (dd && !dd.classList.contains('hidden') && !dd.contains(e.target) && btn && !btn.contains(e.target)) dd.classList.add('hidden');
        });

        function updateSubjectsUI() {
            const btnText = document.getElementById('subjects-text');
            const tagsContainer = document.getElementById('selected-subjects-tags');
            if (selectedSubjects.length === 0) { btnText.innerText = "Seleccionar..."; btnText.classList.remove('text-teal-500', 'font-bold'); } 
            else { btnText.innerText = `${selectedSubjects.length} seleccionados`; btnText.classList.add('text-teal-500', 'font-bold'); }
            tagsContainer.innerHTML = '';
            selectedSubjects.forEach(subj => {
                const itemData = allSubjectsData.find(i => i.value === subj);
                const tag = document.createElement('div');
                tag.className = "bg-teal-500/10 text-teal-400 text-xs px-3 py-1.5 rounded-lg flex items-center gap-2 border border-teal-500/20 animate-fade-in select-none";
                tag.innerHTML = `${itemData ? itemData.label : subj} <button onclick="removeSubject('${subj}')" class="hover:text-red-500 focus:outline-none flex items-center"><i class="ph-bold ph-x"></i></button>`;
                tagsContainer.appendChild(tag);
            });
            document.querySelectorAll('.subject-checkbox').forEach(cb => cb.checked = selectedSubjects.includes(cb.value));
        }

        window.toggleSubject = (value) => {
            if (selectedSubjects.includes(value)) selectedSubjects = selectedSubjects.filter(s => s !== value);
            else { if (selectedSubjects.length >= 5) return alert("Máximo 5 personajes."); selectedSubjects.push(value); }
            updateSubjectsUI();
        };
        window.removeSubject = (value) => { selectedSubjects = selectedSubjects.filter(s => s !== value); updateSubjectsUI(); };

        let predefinedChars = [];
        let predefinedVoices = { tones:[], accents:[], langs:[] };

        onSnapshot(doc(db, "vision_config", "json_chars"), snap => { if(snap.exists() && snap.data().items) predefinedChars = snap.data().items; });
        ['json_tones', 'json_accents', 'json_langs'].forEach(cat => {
            onSnapshot(doc(db, "vision_config", cat), snap => {
                const key = cat.replace('json_','');
                if(snap.exists() && snap.data().items) predefinedVoices[key] = snap.data().items;
            });
        });

        const jsonCats = {'json_cam_mov': 'j-cam-mov', 'json_cam_frame': 'j-cam-frame'};
        Object.keys(jsonCats).forEach(cat => {
            onSnapshot(doc(db, "vision_config", cat), snap => {
                const select = document.getElementById(jsonCats[cat]); 
                if(select) {
                    const first = select.options[0]; select.innerHTML = ''; select.appendChild(first);
                    if(snap.exists() && snap.data().items) snap.data().items.forEach(i => { const opt = document.createElement('option'); opt.value = i.value; opt.innerText = i.label; select.appendChild(opt); });
                }
            });
        });

        window.addJsonCharacter = () => {
            const container = document.getElementById('json-chars-container');
            const emptyMsg = document.getElementById('empty-chars-msg');
            if(emptyMsg) emptyMsg.remove();

            const currentCards = container.querySelectorAll('[id^="char-card-"]');
            const newId = currentCards.length + 1; 
            
            const div = document.createElement('div');
            div.id = `char-card-${newId}`;
            // Glass Card Style
            div.className = "char-card glass-panel rounded-xl p-5 relative animate-fade-in border border-white/5";
            
            let charOptions = '<option value="">-- Seleccionar Base --</option>';
            predefinedChars.forEach(c => charOptions += `<option value="${c.label}" data-desc="${c.value}" data-tone="${c.tone||''}" data-accent="${c.accent||''}" data-lang="${c.lang||''}">${c.label}</option>`);
            
            const getOpts = (list) => { let html = '<option value="none">Default</option>'; if(list) list.forEach(i => html += `<option value="${i.value}">${i.label}</option>`); return html; };

            div.innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-3">
                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wide">Personaje #${newId}</h4>
                    <button onclick="removeJsonCharacter(${newId})" id="btn-del-${newId}" class="remove-char-btn text-red-400 hover:text-red-500 transition-colors p-1 rounded hover:bg-red-500/10"><i class="ph-bold ph-trash"></i></button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 gap-3">
                         <div class="flex items-center gap-3">
                            <select class="j-char-select flex-1 glass-input rounded-lg p-2 text-xs text-gray-300 outline-none" onchange="fillCharData(${newId}, this)">${charOptions}</select>
                            <label class="flex items-center cursor-pointer gap-2 select-none">
                                <div class="relative">
                                    <input type="checkbox" id="custom-toggle-${newId}" class="sr-only" onchange="toggleCustomChar(${newId})">
                                    <div class="block bg-gray-600 w-8 h-4 rounded-full transition-colors toggle-bg"></div>
                                    <div class="dot absolute left-0.5 top-0.5 bg-white w-3 h-3 rounded-full transition transition-transform"></div>
                                </div>
                                <span class="text-[10px] font-bold text-gray-400">EDIT</span>
                            </label>
                        </div>
                    </div>
                    <div class="space-y-3 p-3 bg-black/20 rounded-lg border border-white/5">
                        <input type="text" id="char-name-${newId}" class="j-char-name w-full bg-transparent border-b border-white/10 text-sm font-bold text-white pb-1 focus:border-teal-500 outline-none placeholder-gray-600" placeholder="Nombre" readonly>
                        <input type="text" id="char-desc-${newId}" class="j-char-desc w-full bg-transparent border-b border-white/10 text-xs text-gray-400 pb-1 focus:border-teal-500 outline-none placeholder-gray-600" placeholder="Descripción visual..." readonly>
                    </div>
                    <textarea class="j-char-dial w-full glass-input rounded-lg p-3 text-sm text-white outline-none h-20 resize-none placeholder-gray-500" placeholder="Escribe el diálogo aquí..."></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] uppercase font-bold text-gray-500 block mb-1">Tono</label><select id="char-tone-${newId}" class="j-char-tone w-full glass-input rounded p-2 text-xs text-gray-300">${getOpts(predefinedVoices.tones)}</select></div>
                        <div><label class="text-[10px] uppercase font-bold text-gray-500 block mb-1">Acento</label><select id="char-acc-${newId}" class="j-char-acc w-full glass-input rounded p-2 text-xs text-gray-300">${getOpts(predefinedVoices.accents)}</select></div>
                        <div><label class="text-[10px] uppercase font-bold text-gray-500 block mb-1">Idioma</label><select id="char-lang-${newId}" class="j-char-lang w-full glass-input rounded p-2 text-xs text-gray-300">${getOpts(predefinedVoices.langs)}</select></div>
                        <div><label class="text-[10px] uppercase font-bold text-gray-500 block mb-1">Acción</label><input type="text" class="j-char-act w-full glass-input rounded p-2 text-xs text-gray-300" placeholder="none" value="none"></div>
                    </div>
                </div>`;
            container.appendChild(div);
            updateDeleteButtonsState();
        };

        function updateDeleteButtonsState() {
            const cards = document.querySelectorAll('.char-card');
            const total = cards.length;
            cards.forEach((card, index) => {
                const btn = card.querySelector('.remove-char-btn');
                if (btn) {
                    if (index === total - 1) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-20', 'cursor-not-allowed', 'pointer-events-none');
                        btn.classList.add('cursor-pointer');
                    } else {
                        btn.disabled = true;
                        btn.classList.add('opacity-20', 'cursor-not-allowed', 'pointer-events-none');
                        btn.classList.remove('cursor-pointer');
                    }
                }
            });
        }

        window.removeJsonCharacter = (id) => {
            const container = document.getElementById('json-chars-container');
            const card = document.getElementById(`char-card-${id}`);
            const allCards = container.querySelectorAll('.char-card');
            
            if(card && allCards[allCards.length - 1] === card) {
                card.remove();
                if (container.querySelectorAll('.char-card').length === 0) {
                     container.innerHTML = '<div id="empty-chars-msg" class="text-center py-8 text-gray-500 text-sm border-2 border-dashed border-white/5 rounded-xl">No hay personajes agregados.</div>';
                } else {
                    updateDeleteButtonsState();
                }
            }
        };

        window.fillCharData = (id, select) => {
            const op = select.options[select.selectedIndex];
            document.getElementById(`char-name-${id}`).value = op.value;
            document.getElementById(`char-desc-${id}`).value = op.getAttribute('data-desc') || '';
            const t = op.getAttribute('data-tone'); if(t) document.getElementById(`char-tone-${id}`).value = t;
            const a = op.getAttribute('data-accent'); if(a) document.getElementById(`char-acc-${id}`).value = a;
            const l = op.getAttribute('data-lang'); if(l) document.getElementById(`char-lang-${id}`).value = l;
        };

        window.toggleCustomChar = (id) => {
            const isC = document.getElementById(`custom-toggle-${id}`).checked;
            const selDiv = document.querySelector(`#char-card-${id} .j-char-select`).parentElement;
            const n = document.getElementById(`char-name-${id}`);
            const d = document.getElementById(`char-desc-${id}`);
            const bg = document.querySelector(`#char-card-${id} .toggle-bg`);
            const dot = document.querySelector(`#char-card-${id} .dot`);
            if (isC) { 
                selDiv.classList.add('opacity-30','pointer-events-none'); n.readOnly=false; d.readOnly=false; n.focus(); 
                bg.classList.replace('bg-gray-600','bg-teal-500'); dot.classList.add('translate-x-4'); n.parentElement.classList.add('ring-1', 'ring-teal-500/50');
            } else { 
                selDiv.classList.remove('opacity-30','pointer-events-none'); n.readOnly=true; d.readOnly=true; 
                bg.classList.replace('bg-teal-500','bg-gray-600'); dot.classList.remove('translate-x-4'); n.parentElement.classList.remove('ring-1', 'ring-teal-500/50');
            }
        };

        window.generateJson = () => {
            const scene = document.getElementById('j-scene').value;
            const style = document.getElementById('j-style').value;
            const camMov = document.getElementById('j-cam-mov').value;
            const camFrame = document.getElementById('j-cam-frame').value;
            const charCards = document.querySelectorAll('[id^="char-card-"]');
            const characters = Array.from(charCards).map(card => ({
                name: card.querySelector('.j-char-name').value, 
                description: card.querySelector('.j-char-desc').value, 
                dialogue: card.querySelector('.j-char-dial').value,
                voice: { tone: card.querySelector('.j-char-tone').value, accent: card.querySelector('.j-char-acc').value, language: card.querySelector('.j-char-lang').value, action: card.querySelector('.j-char-act').value }
            }));
            const finalObj = { scene, characters, camera: { movement: camMov, framing: camFrame }, style };
            const jsonString = JSON.stringify(finalObj, null, 2).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    let cls = 'json-number';
                    if (/^"/.test(match)) { if (/:$/.test(match)) { cls = 'json-key'; } else { cls = 'json-string'; } } else if (/true|false/.test(match)) { cls = 'json-boolean'; } else if (/null/.test(match)) { cls = 'json-null'; }
                    return '<span class="' + cls + '">' + match + '</span>';
            });
            document.getElementById('json-output').innerHTML = jsonString;
        };

        window.copyJson = () => { const t = document.getElementById('json-output').innerText; navigator.clipboard.writeText(t); };

        const categories = ['formats', 'subjects', 'styles', 'lighting', 'camera', 'ratios']; 
        categories.forEach(cat => { onSnapshot(doc(db, "vision_config", cat), snap => { const s = document.getElementById(`p-${cat}`); if(!s)return; s.innerHTML='<option value="">none</option>'; if(snap.exists() && snap.data().items) snap.data().items.forEach(i => { const o=document.createElement('option'); o.value=i.value; o.innerText=i.label; s.appendChild(o); }); }); });
        onSnapshot(doc(db, "vision_config", "general"), snap => { if(snap.exists()){ const d=snap.data(); document.getElementById('vision-main-title').innerText=d.title||"Vision Prompt"; document.getElementById('vision-main-desc').innerText=d.desc||""; } });
        onSnapshot(doc(db,"vision_config","subjects"), s=>{
            const d=document.getElementById('subjects-dropdown');
            if(d&&s.exists()&&s.data().items){
                allSubjectsData=s.data().items; d.innerHTML=''; if(allSubjectsData.length===0) d.innerHTML='<p class="text-xs text-center p-2">Vacío</p>';
                allSubjectsData.forEach(i=>{
                    const l=document.createElement('label');
                    l.className="custom-checkbox flex items-center justify-between p-3 hover:bg-white/5 cursor-pointer border-b border-white/5 last:border-0 transition-colors";
                    l.innerHTML=`<span class="text-sm text-gray-300">${i.label}</span><input type="checkbox" class="subject-checkbox hidden" value="${i.value}" onchange="toggleSubject('${i.value}')"><div class="w-5 h-5 border-2 border-gray-400 rounded flex items-center justify-center text-white transition-colors"><i class="ph-bold ph-check text-xs hidden"></i></div>`;
                    d.appendChild(l);
                });
                updateSubjectsUI();
            }
        });

        window.assemblePrompt=()=>{
            const c=document.getElementById('p-concept').value.trim(), f=document.getElementById('p-formats').value, st=document.getElementById('p-styles').value, l=document.getElementById('p-lighting').value, cm=document.getElementById('p-camera').value, ar=document.getElementById('p-ratios').value;
            if(!c && selectedSubjects.length===0) { document.getElementById('p-concept').focus(); document.getElementById('p-concept').parentElement.classList.add('ring-2', 'ring-red-500'); setTimeout(()=>document.getElementById('p-concept').parentElement.classList.remove('ring-2', 'ring-red-500'), 1000); return; }
            let p=[]; if(f) p.push(f + (selectedSubjects.length>0 ? " of" : "")); if(selectedSubjects.length>0) p.push(selectedSubjects.join(" and ")); if(c) p.push(c); if(st) p.push(st); if(l) p.push(l); if(cm) p.push(cm); p.push("8k resolution, highly detailed, masterpiece"); let fp = p.join(", "); if(ar) fp += ` ${ar}`;
            const out = document.getElementById('prompt-output'); out.innerHTML = fp;
            const box = document.getElementById('vision-controls-box'); box.classList.remove('aurora-active'); void box.offsetWidth; box.classList.add('aurora-active');
        };
        window.copyPrompt=()=>{ navigator.clipboard.writeText(document.getElementById('prompt-output').innerText); };

        const sc=document.getElementById('video-scroll-container');
        for(let i=1;i<=5;i++){
            const sid=`slot_${i}`, d=document.createElement('div');
            // Cards Glass
            d.id=`render-${sid}`; d.className="snap-center flex-shrink-0 relative w-[260px] h-[460px] rounded-3xl overflow-hidden glass-panel group shadow-2xl transition-transform duration-300 hover:scale-[1.02] border border-white/5";
            d.innerHTML=`<div class="w-full h-full flex flex-col items-center justify-center bg-black/40 animate-pulse"><div class="w-12 h-12 rounded-full bg-white/5 mb-4"></div><div class="h-2 w-20 bg-white/5 rounded"></div></div>`; sc.appendChild(d);
            onSnapshot(doc(db,"home_slots",sid), s=>{
                const el=document.getElementById(`render-${sid}`);
                if(s.exists() && s.data().url){
                    const da=s.data(), v=da.tipo==='video', content = v ? `<video id="vid-${sid}" src="${da.url}" class="absolute inset-0 w-full h-full object-cover transform scale-105 video-locked" autoplay loop muted playsinline disablePictureInPicture></video>` : `<img src="${da.url}" class="absolute inset-0 w-full h-full object-cover transform hover:scale-110 transition-transform duration-[2s]">`;
                    let muteBtn = v ? `<button onclick="toggleSlotAudio('vid-${sid}',this)" class="absolute top-4 right-4 z-30 w-10 h-10 rounded-full bg-black/40 backdrop-blur-md flex items-center justify-center text-white border border-white/10 hover:bg-white/20 transition-all active:scale-95"><i class="ph-fill ph-speaker-slash text-lg"></i></button>` : '';
                    el.innerHTML=`${content}<div class="click-shield"></div><div class="absolute inset-0 z-20 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-80 pointer-events-none"></div><div class="absolute bottom-0 left-0 p-6 text-white z-20 w-full pointer-events-none"><div class="flex items-center gap-2 mb-2"><div class="w-6 h-6 rounded-full bg-gradient-to-tr from-blue-400 to-purple-500 flex items-center justify-center text-[10px] font-bold shadow-lg shadow-purple-500/30">G</div><p class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">${da.autor||'Galaxy Creator'}</p></div><h3 class="text-xl font-bold leading-tight tracking-tight">${da.titulo||'Sin Título'}</h3></div>${muteBtn}`; attachShieldListeners();
                } else { el.innerHTML=`<div class="w-full h-full flex items-center justify-center bg-[#0a0a0a] border border-white/5"><i class="ph-duotone ph-plus text-4xl text-gray-800"></i></div>`; }
            });
        }
        function attachShieldListeners(){ document.querySelectorAll('.click-shield').forEach(s=>{ s.addEventListener('contextmenu',e=>e.preventDefault()); s.addEventListener('dragstart',e=>e.preventDefault()); }); }
        window.toggleSlotAudio=(id,b)=>{ const v=document.getElementById(id), i=b.querySelector('i'); if(v.muted){ v.muted=false; i.className="ph-fill ph-speaker-high text-lg text-teal-300"; b.classList.add('bg-teal-900/40', 'border-teal-500/50'); }else{ v.muted=true; i.className="ph-fill ph-speaker-slash text-lg"; b.classList.remove('bg-teal-900/40', 'border-teal-500/50'); } };
        
        const ap=document.getElementById('audio-player'), vr=document.getElementById('vinyl-record');
        onSnapshot(query(collection(db,"productos"),orderBy("createdAt","desc")), s=>{
            const c=document.getElementById('items-container'), pc=document.getElementById('playlist-container'), w=document.getElementById('music-widget');
            c.innerHTML=''; pc.innerHTML=''; if(s.empty){ c.innerHTML='<div class="col-span-full text-center text-gray-500 py-20 flex flex-col items-center"><i class="ph-duotone ph-image text-4xl mb-2"></i><p>No hay contenido disponible</p></div>'; return; }
            s.forEach(d=>{
                const i=d.data();
                if(i.tipo==='audio'){
                    const dv=document.createElement('div'); dv.className="p-3 hover:bg-white/10 rounded-lg flex justify-between items-center cursor-pointer border-b border-transparent hover:border-white/5 transition-colors group"; dv.innerHTML=`<div class="flex items-center gap-2 overflow-hidden"><i class="ph-fill ph-music-note text-gray-400 group-hover:text-teal-400"></i><span class="text-xs font-bold truncate text-gray-300 group-hover:text-white transition-colors">${i.titulo}</span></div><i class="ph-fill ph-play-circle text-gray-400 group-hover:text-teal-400 text-lg"></i>`; dv.onclick=()=>playSong(i.url); pc.appendChild(dv); w.classList.remove('hidden');
                } else {
                    let m = i.tipo==='video' ? `<video controls class="w-full h-64 object-cover bg-black group-hover:scale-105 transition-transform duration-500"><source src="${i.url}"></video>` : `<img src="${i.url}" class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-500">`;
                    const cd=document.createElement('div'); cd.className="glass-panel rounded-2xl overflow-hidden shadow-sm hover:shadow-2xl hover:shadow-teal-900/10 group transition-all duration-300"; cd.innerHTML=`<div class="overflow-hidden relative">${m}<div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div></div><div class="p-5"><h3 class="font-bold text-lg text-white mb-1">${i.titulo}</h3><p class="text-xs text-teal-400 font-bold tracking-wide uppercase">${i.precio||'Free'}</p></div>`; c.appendChild(cd);
                }
            });
        });
        window.playSong=(u)=>{ ap.src=u; ap.play(); upUI(true); }; ap.onpause = () => upUI(false); ap.onplay = () => upUI(true);
        function upUI(playing){ if(playing){ vr.classList.remove('spin-paused'); }else{ vr.classList.add('spin-paused'); } }
    </script>
</body>
    </html>
