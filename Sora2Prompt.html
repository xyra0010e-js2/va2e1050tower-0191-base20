<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sora2Prompt Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconos -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#050505', 
                        glass: 'rgba(255, 255, 255, 0.03)',
                        galaxyPrimary: '#7c3aed',
                        galaxySecondary: '#2dd4bf',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: {
                        'aurora': 'aurora-flow 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        'aurora-flow': {
                            '0%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' },
                            '100%': { backgroundPosition: '0% 50%' }
                        },
                        fadeIn: {
                            'from': { opacity: '0', transform: 'translateY(10px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s ease;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #2dd4bf;
            outline: none;
        }

        .bg-aurora {
            background: linear-gradient(90deg, rgba(45, 212, 191, 0.1), rgba(167, 139, 250, 0.1), rgba(244, 114, 182, 0.1));
            background-size: 200% 200%;
            animation: aurora-flow 6s ease-in-out infinite;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* Toggles */
        .toggle-checkbox:checked { right: 0; border-color: #2dd4bf; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2dd4bf; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* Animation for blocks */
        .block-enter { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 pb-32">

    <!-- Background Decoration -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0 opacity-30">
        <div class="absolute top-0 left-0 w-[600px] h-[600px] bg-purple-900/20 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-0 right-0 w-[600px] h-[600px] bg-teal-900/20 rounded-full blur-[120px]"></div>
    </div>

    <!-- API KEY MODAL -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[60] flex items-center justify-center hidden animate-fade-in">
        <div class="glass-panel w-full max-w-md p-6 rounded-2xl border border-white/10 shadow-2xl relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="ph-bold ph-x text-lg"></i></button>
            
            <h2 class="text-xl font-bold text-white mb-1 flex items-center gap-2">
                <i class="ph-fill ph-gear text-teal-400"></i> Configuración
            </h2>
            <p class="text-xs text-gray-400 mb-6">Configura tu acceso a la IA de Gemini.</p>
            
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-300 uppercase">Gemini API Key</label>
                    <div class="relative">
                        <input type="password" id="api-key-input" class="glass-input w-full rounded-xl p-3 pl-10 text-sm text-white placeholder-gray-600 focus:border-teal-500" placeholder="Pega tu API Key aquí (AIzaSy...)">
                        <i class="ph-bold ph-key absolute left-3 top-3.5 text-gray-500"></i>
                        <button onclick="toggleKeyVisibility()" class="absolute right-3 top-3.5 text-gray-500 hover:text-white">
                            <i class="ph-bold ph-eye" id="eye-icon"></i>
                        </button>
                    </div>
                    <p class="text-[10px] text-gray-500">La clave se guarda localmente en tu navegador. Nunca se comparte.</p>
                </div>
                
                <button onclick="saveApiKey()" class="w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2">
                    <i class="ph-bold ph-check-circle"></i> Guardar y Aplicar
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto relative z-10">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-end mb-8 border-b border-white/5 pb-6 animate-fade-in gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight mb-1">Sora 2.0 <span class="text-teal-400">Builder Pro</span></h1>
                <p class="text-gray-400 text-sm">Editor modular profesional con IA (Vision).</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-4">
                <!-- Botón Ajustes -->
                <button onclick="toggleSettings()" class="relative p-2.5 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-gray-300 transition-colors" title="Configurar API Key">
                    <i class="ph-fill ph-gear text-lg"></i>
                    <span id="api-status-dot" class="absolute top-2 right-2 w-2 h-2 rounded-full bg-red-500 border border-[#050505]"></span>
                </button>

                <div class="h-8 w-px bg-white/10 mx-2 hidden md:block"></div>

                <!-- Duration Preset Switch -->
                <div class="glass-panel p-1 rounded-xl flex items-center bg-black/40">
                    <button onclick="setPreset(10)" id="btn-10s" class="px-5 py-2 rounded-lg text-xs font-bold transition-all bg-teal-500/20 text-teal-300 border border-teal-500/30">10s (3 Bloques)</button>
                    <button onclick="setPreset(15)" id="btn-15s" class="px-5 py-2 rounded-lg text-xs font-bold transition-all text-gray-400 hover:text-white border border-transparent">15s (5 Bloques)</button>
                </div>

                <div class="h-8 w-px bg-white/10 mx-2 hidden md:block"></div>

                <!-- Botones IA -->
                <button onclick="improveDialogues()" class="bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 hover:text-white border border-blue-500/30 font-bold py-2.5 px-4 rounded-xl transition-all flex items-center gap-2 text-xs backdrop-blur-md shadow-lg">
                    <i class="ph-fill ph-chats-circle text-lg"></i> Mejorar Diálogos
                </button>

                <button onclick="fillWithAI()" id="btn-ai" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg hover:shadow-purple-500/20 active:scale-95 transition-all flex items-center gap-2 text-sm border border-white/10">
                    <i class="ph-fill ph-sparkle"></i> Auto-Rellenar IA
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
            
            <!-- COL 1: CONFIG GLOBAL (Izquierda) -->
            <div class="lg:col-span-3 space-y-6 animate-fade-in">
                <div class="glass-panel p-5 rounded-2xl shadow-sm border-l-4 border-l-teal-500">
                    <h3 class="text-xs font-bold text-teal-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="ph-fill ph-sliders-horizontal"></i> Configuración Global
                    </h3>
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Título</label>
                            <input type="text" id="g-title" placeholder="Ej: Doñas en el Mercado" class="glass-input w-full rounded-lg p-2.5 text-sm text-white placeholder-gray-600">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Género</label>
                            <input type="text" id="g-genre" placeholder="Ej: Sketch Humor Realista" class="glass-input w-full rounded-lg p-2.5 text-sm text-white placeholder-gray-600">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Idioma</label>
                            <input type="text" id="g-lang" value="Español Latino" class="glass-input w-full rounded-lg p-2.5 text-sm text-white">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Contexto / Premisa</label>
                            <textarea id="g-context" class="glass-input w-full rounded-lg p-3 text-sm text-white placeholder-gray-600 h-32 resize-none" placeholder="Describe la escena general y el tono..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- GESTOR REPARTO -->
                <div class="glass-panel p-5 rounded-2xl shadow-sm border-l-4 border-l-purple-500">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold text-purple-500 uppercase tracking-widest flex items-center gap-2">
                            <i class="ph-fill ph-users"></i> Reparto Global
                        </h3>
                    </div>
                    
                    <!-- INPUT MANUAL -->
                    <div class="space-y-2 mb-6 bg-white/5 p-3 rounded-xl border border-white/10">
                        <span class="text-[9px] text-gray-500 uppercase font-bold ml-1">Manual</span>
                        <input type="text" id="new-char-name" placeholder="Nombre (ej: Doña Lupita)" class="glass-input w-full rounded-lg p-2 text-xs text-white placeholder-gray-500 focus:border-purple-500 font-bold">
                        <input type="text" id="new-char-desc" placeholder="Descripción (ej: 55 años, mandil)" class="glass-input w-full rounded-lg p-2 text-xs text-white placeholder-gray-500 focus:border-purple-500" onkeydown="if(event.key==='Enter') addCharacter()">
                        <button onclick="addCharacter()" class="w-full bg-purple-600 hover:bg-purple-500 text-white rounded-lg py-2 text-xs font-bold transition-colors shadow-lg flex items-center justify-center gap-1">
                            <i class="ph-bold ph-plus"></i> Añadir
                        </button>
                    </div>

                    <!-- INPUT CON IA -->
                    <div class="space-y-2 mb-4 bg-gradient-to-br from-indigo-900/30 to-purple-900/30 p-3 rounded-xl border border-indigo-500/30">
                        <span class="text-[9px] text-indigo-400 uppercase font-bold ml-1 flex items-center gap-1"><i class="ph-fill ph-sparkle"></i> Crear con IA</span>
                        <textarea id="ai-char-idea" class="glass-input w-full rounded-lg p-2 text-xs text-white placeholder-gray-500 focus:border-indigo-500 h-16 resize-none" placeholder="Idea: Un robot sarcástico que vende tacos..."></textarea>
                        <button onclick="generateAICharacter()" id="btn-gen-char" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg py-2 text-xs font-bold transition-colors shadow-lg flex items-center justify-center gap-1">
                            <i class="ph-bold ph-magic-wand"></i> Generar Personaje
                        </button>
                    </div>

                    <div id="chars-list" class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar">
                        <div class="text-xs text-gray-500 text-center py-4 italic border border-dashed border-white/5 rounded-lg" id="no-chars">
                            Lista vacía.<br>Agrega personajes para usarlos en el VO.
                        </div>
                    </div>
                </div>
            </div>

            <!-- COL 2: EDITOR DE BLOQUES (Centro - Scrollable) -->
            <div class="lg:col-span-6 relative flex flex-col h-[calc(100vh-140px)]">
                <div class="flex justify-between items-center mb-3 px-2">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="ph-bold ph-film-strip"></i> Línea de Tiempo
                    </span>
                    <span id="total-blocks-label" class="text-[10px] bg-white/10 px-2 py-1 rounded text-gray-300">3 Bloques</span>
                </div>
                
                <div id="blocks-container" class="flex-1 overflow-y-auto custom-scrollbar space-y-6 pb-24 pr-2 pl-1">
                    <!-- Los bloques se inyectan aquí con JS -->
                </div>

                <!-- Botón Flotante Añadir Bloque -->
                <div class="absolute bottom-6 left-0 right-0 flex justify-center z-10">
                    <button onclick="addNewBlock()" class="bg-black/60 backdrop-blur-xl border border-white/20 text-white hover:bg-white/10 px-6 py-3 rounded-full shadow-[0_0_20px_rgba(0,0,0,0.5)] transition-all flex items-center gap-2 text-xs font-bold uppercase tracking-wider group hover:scale-105 hover:border-teal-500/50">
                        <i class="ph-bold ph-plus-circle text-teal-400 group-hover:rotate-90 transition-transform duration-300"></i> Añadir Bloque
                    </button>
                </div>
            </div>

            <!-- COL 3: SALIDA (Derecha - Sticky) -->
            <div class="lg:col-span-3">
                <div class="glass-panel rounded-2xl shadow-2xl overflow-hidden flex flex-col h-[calc(100vh-140px)] border border-white/10 sticky top-0">
                    <div class="bg-black/20 p-3 border-b border-white/5 flex justify-between items-center px-4 backdrop-blur-md">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-[10px] font-mono text-gray-400 uppercase tracking-widest">Script_Final.txt</span>
                        </div>
                        <button onclick="copyOutput()" class="text-xs bg-white/5 hover:bg-white/10 text-gray-300 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                            <i class="ph-bold ph-copy"></i> Copiar
                        </button>
                    </div>
                    <textarea id="final-output" class="flex-1 bg-[#080808] p-4 text-xs md:text-sm font-mono leading-relaxed text-gray-300 resize-none focus:outline-none custom-scrollbar" readonly placeholder="// Pulsa 'Compilar' para generar el archivo de texto..."></textarea>
                    
                    <!-- Botones Finales -->
                    <div class="p-4 border-t border-white/5 bg-black/20 space-y-3">
                        <button onclick="generateRandomPrompt()" class="w-full bg-gradient-to-r from-pink-600/20 to-purple-600/20 text-pink-300 hover:text-white border border-pink-500/30 hover:bg-pink-600/30 font-bold py-2 rounded-xl transition-all flex justify-center items-center gap-2 text-xs backdrop-blur-md">
                            <i class="ph-bold ph-dice-five"></i> Generar Random (Español)
                        </button>
                        <button onclick="compilePrompt()" class="w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2 transform active:scale-[0.98]">
                            <i class="ph-bold ph-code"></i> Compilar Estructura
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[70] flex flex-col items-center justify-center hidden transition-opacity duration-300">
        <div class="w-16 h-16 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin mb-4"></div>
        <p id="loading-text" class="text-purple-300 text-sm font-bold uppercase tracking-widest animate-pulse">Gemini está escribiendo...</p>
    </div>

    <!-- LOGIC -->
    <script>
        // State Global
        let characters = [];
        let blockCounter = 0; // Para IDs únicos
        
        // Cargar API Key del LocalStorage
        let currentApiKey = localStorage.getItem("SORA_GEMINI_KEY") || "";

        // Inicialización
        window.onload = () => {
            updateApiStatus();
            setPreset(10); // Cargar preset por defecto
            
            // Si no hay key, abre el modal
            if(!currentApiKey) toggleSettings();
        };

        // --- GESTIÓN DE SETTINGS (API KEY) ---
        window.toggleSettings = () => {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            document.getElementById('api-key-input').value = currentApiKey;
        };

        window.toggleKeyVisibility = () => {
            const input = document.getElementById('api-key-input');
            const icon = document.getElementById('eye-icon');
            if(input.type === "password") {
                input.type = "text";
                icon.className = "ph-bold ph-eye-slash";
            } else {
                input.type = "password";
                icon.className = "ph-bold ph-eye";
            }
        };

        window.saveApiKey = () => {
            const key = document.getElementById('api-key-input').value.trim();
            if(!key) { alert("Ingresa una clave válida."); return; }
            
            localStorage.setItem("SORA_GEMINI_KEY", key);
            currentApiKey = key;
            updateApiStatus();
            toggleSettings();
            alert("API Key guardada localmente.");
        };

        function updateApiStatus() {
            const dot = document.getElementById('api-status-dot');
            if(currentApiKey) {
                dot.className = "absolute top-2 right-2 w-2 h-2 rounded-full bg-green-500 border border-[#050505] shadow-[0_0_5px_#22c55e]";
            } else {
                dot.className = "absolute top-2 right-2 w-2 h-2 rounded-full bg-red-500 border border-[#050505] animate-pulse";
            }
        }

        // --- GESTIÓN DE PRESETS (10s / 15s) ---
        window.setPreset = (sec) => {
            const container = document.getElementById('blocks-container');
            container.innerHTML = ''; // Limpieza completa del DOM
            
            const count = sec === 10 ? 3 : 5;
            
            for(let i=0; i<count; i++) {
                createBlockDOM(); 
            }
            updateBlockNumbers();

            // UI Update Buttons
            const b10 = document.getElementById('btn-10s');
            const b15 = document.getElementById('btn-15s');
            const active = "bg-teal-500/20 text-teal-300 border border-teal-500/30 shadow-[0_0_10px_rgba(45,212,191,0.2)]";
            const inactive = "text-gray-400 hover:text-white border border-transparent";
            
            if(sec === 10) { b10.className = `px-5 py-2 rounded-lg text-xs font-bold transition-all ${active}`; b15.className = `px-5 py-2 rounded-lg text-xs font-bold transition-all ${inactive}`; }
            else { b15.className = `px-5 py-2 rounded-lg text-xs font-bold transition-all ${active}`; b10.className = `px-5 py-2 rounded-lg text-xs font-bold transition-all ${inactive}`; }
        };

        // --- SISTEMA DE BLOQUES DOM ---
        
        window.addNewBlock = () => {
            createBlockDOM();
            updateBlockNumbers();
            setTimeout(() => {
                const container = document.getElementById('blocks-container');
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            }, 100);
        };

        function createBlockDOM(data = null) {
            blockCounter++;
            const container = document.getElementById('blocks-container');
            const div = document.createElement('div');
            div.className = "glass-panel p-0 rounded-xl border border-white/5 block-item block-enter mb-6 relative group overflow-visible bg-[#0a0a0a]/50 shadow-lg";
            div.id = `block-unique-${blockCounter}`;
            
            // Valores por defecto
            const valCamType = data ? data.cameraType : "MEDIUM SHOT";
            const valCamDesc = data ? data.camera : "";
            const valSvx = data ? data.svx : "";
            const valVo = data ? data.vo : "";
            const valTransType = data ? data.transType : "Straight Cut";
            const valTransDesc = data ? data.transition : "";

            div.innerHTML = `
                <!-- HEADER BLOQUE -->
                <div class="flex justify-between items-center p-3 border-b border-white/5 bg-gradient-to-r from-white/5 to-transparent rounded-t-xl">
                    <div class="flex items-center gap-3">
                        <span class="block-number text-[10px] font-black text-black bg-teal-500 px-2 py-0.5 rounded shadow-lg shadow-teal-500/20">BLOCK #</span>
                        <div class="h-px w-8 bg-white/10"></div>
                    </div>
                    <button onclick="removeBlock('${div.id}')" class="text-gray-500 hover:text-red-400 transition-colors p-1.5 rounded-lg hover:bg-red-500/10 opacity-60 group-hover:opacity-100" title="Eliminar Bloque">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                </div>
                
                <div class="p-4 space-y-4">
                    
                    <!-- CAMERA -->
                    <div class="bg-black/30 rounded-lg p-2 border border-white/5 group-hover:border-blue-500/20 transition-all">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[9px] font-bold text-blue-400 uppercase flex items-center gap-1"><i class="ph-fill ph-video-camera"></i> Camera</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer toggle-section" checked onchange="toggleSection(this)">
                                <div class="w-6 h-3 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-500 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[0px] after:left-[0px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all"></div>
                            </label>
                        </div>
                        <div class="section-content space-y-2">
                            <select class="cam-select w-full bg-white/5 border border-white/10 rounded p-1 text-[10px] text-gray-300 focus:border-blue-500 outline-none">
                                <option value="ESTABLISHING SHOT">ESTABLISHING SHOT</option>
                                <option value="WIDE SHOT">WIDE SHOT</option>
                                <option value="MEDIUM SHOT" selected>MEDIUM SHOT</option>
                                <option value="CLOSE UP">CLOSE UP</option>
                                <option value="EXTREME CLOSE UP">EXTREME CLOSE UP</option>
                                <option value="TRACKING SHOT">TRACKING SHOT</option>
                                <option value="HANDHELD">HANDHELD</option>
                            </select>
                            <textarea class="section-input w-full bg-transparent text-xs text-gray-400 placeholder-gray-700 focus:outline-none resize-none h-10 custom-scrollbar" placeholder="Detalles visuales...">${valCamDesc}</textarea>
                        </div>
                    </div>

                    <!-- SVX -->
                    <div class="bg-black/30 rounded-lg p-2 border border-white/5 group-hover:border-yellow-500/20 transition-all">
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-[9px] font-bold text-yellow-400 uppercase flex items-center gap-1"><i class="ph-fill ph-speaker-high"></i> SVX (Sonido)</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer toggle-section" checked onchange="toggleSection(this)">
                                <div class="w-6 h-3 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:bg-yellow-500 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[0px] after:left-[0px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all"></div>
                            </label>
                        </div>
                        <div class="section-content">
                            <textarea class="section-input w-full bg-transparent text-xs text-gray-300 placeholder-gray-700 focus:outline-none resize-none h-10 custom-scrollbar" placeholder="Ambiente, ruidos, efectos...">${valSvx}</textarea>
                        </div>
                    </div>

                    <!-- VO (Voice Over) - MODULO PRO -->
                    <div class="bg-black/30 rounded-lg p-4 border border-white/5 group-hover:border-green-500/20 transition-all shadow-inner relative">
                        <div class="flex items-center justify-between mb-3 border-b border-white/5 pb-2">
                            <label class="text-[10px] font-bold text-green-400 uppercase flex items-center gap-1"><i class="ph-fill ph-microphone"></i> VO (Diálogo)</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer toggle-section" checked onchange="toggleSection(this)">
                                <div class="w-6 h-3 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:bg-green-500 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[0px] after:left-[0px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all"></div>
                            </label>
                        </div>
                        
                        <div class="section-content space-y-3">
                            <!-- SELECTORES DE VOZ (Personaje, Idioma, Acento) -->
                            <div class="grid grid-cols-2 gap-3 mb-2">
                                <div class="space-y-1">
                                    <span class="text-[9px] text-gray-500 uppercase font-bold ml-1">Personaje</span>
                                    <select class="char-select w-full bg-[#111] border border-white/10 rounded-lg p-2 text-[10px] text-gray-200 outline-none focus:border-green-500 transition-colors">
                                        <option value="none">-- Ninguno --</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <span class="text-[9px] text-gray-500 uppercase font-bold ml-1">Idioma</span>
                                    <select class="lang-select w-full bg-[#111] border border-white/10 rounded-lg p-2 text-[10px] text-gray-200 outline-none focus:border-green-500 transition-colors">
                                        <option value="none">-- Default --</option>
                                        <option value="Español">Español</option>
                                        <option value="Inglés">Inglés</option>
                                        <option value="Portugués">Portugués</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="space-y-1">
                                <span class="text-[9px] text-gray-500 uppercase font-bold ml-1">Acento / Región</span>
                                <select class="accent-select w-full bg-[#111] border border-white/10 rounded-lg p-2 text-[10px] text-gray-200 outline-none focus:border-green-500 transition-colors">
                                    <option value="none">-- Ninguno --</option>
                                    <option value="Mexicano">Mexicano</option>
                                    <option value="Argentino">Argentino</option>
                                    <option value="Español (España)">Español (España)</option>
                                    <option value="Chileno">Chileno</option>
                                    <option value="Colombiano">Colombiano</option>
                                    <option value="Neutro">Neutro</option>
                                </select>
                            </div>

                            <textarea class="section-input vo-input w-full bg-[#050505]/50 rounded-lg p-3 text-xs text-gray-200 placeholder-gray-600 focus:outline-none resize-none h-20 custom-scrollbar border border-white/5 focus:border-green-500/30 mt-2" placeholder="Escribe el diálogo aquí (sin nombre)...">${valVo}</textarea>
                        </div>
                    </div>

                    <!-- TRANSITION (SEPARADO) -->
                    <div class="bg-black/30 rounded-lg p-2 border border-white/5 group-hover:border-pink-500/20 transition-all">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[9px] font-bold text-pink-400 uppercase flex items-center gap-1"><i class="ph-fill ph-arrows-left-right"></i> Transition</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer toggle-section" checked onchange="toggleSection(this)">
                                <div class="w-6 h-3 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:bg-pink-500 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[0px] after:left-[0px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all"></div>
                            </label>
                        </div>
                        <div class="section-content space-y-2">
                            <select class="trans-select w-full bg-white/5 border border-white/10 rounded p-1 text-[10px] text-gray-300 focus:border-pink-500 outline-none">
                                <option value="Straight Cut" selected>Straight Cut</option>
                                <option value="Fade Out">Fade Out</option>
                                <option value="Dissolve">Dissolve</option>
                                <option value="Whip Pan">Whip Pan</option>
                                <option value="Jump Cut">Jump Cut</option>
                                <option value="Match Cut">Match Cut</option>
                            </select>
                            <input type="text" class="section-input w-full bg-transparent text-xs text-gray-400 placeholder-gray-700 focus:outline-none" placeholder="Detalle extra (opcional)..." value="${valTransDesc}">
                        </div>
                    </div>

                </div>`;
            
            container.appendChild(div);
            
            // Ajustes de IA
            if(data) {
                const camSel = div.querySelector('.cam-select');
                if(data.cameraType) camSel.value = data.cameraType;
                const transSel = div.querySelector('.trans-select');
                if(data.transType) transSel.value = data.transType;
                if(data.char) {
                    const charSel = div.querySelector('.char-select');
                    setTimeout(() => { if([...charSel.options].some(o=>o.value===data.char)) charSel.value = data.char; }, 50);
                }
            }
            
            updateCharSelectInBlock(div);
        }

        window.removeBlock = (id) => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('opacity-0', 'scale-95');
                setTimeout(() => { el.remove(); updateBlockNumbers(); }, 200);
            }
        };

        function updateBlockNumbers() {
            const blocks = document.querySelectorAll('.block-item');
            blocks.forEach((b, index) => {
                b.querySelector('.block-number').innerText = `BLOCK ${index + 1}`;
            });
            document.getElementById('total-blocks-label').innerText = `${blocks.length} Bloques`;
        }

        window.toggleSection = (checkbox) => {
            const wrapper = checkbox.closest('div').parentElement; 
            const content = wrapper.querySelector('.section-content');
            
            if(checkbox.checked) {
                content.classList.remove('hidden');
                wrapper.classList.remove('opacity-40');
            } else {
                content.classList.add('hidden');
                wrapper.classList.add('opacity-40');
            }
        };

        // --- GESTIÓN DE PERSONAJES ---
        window.addCharacter = (nameVal=null, descVal=null) => {
            let name, desc;
            
            if(nameVal && descVal) {
                name = nameVal;
                desc = descVal;
            } else {
                const nameInput = document.getElementById('new-char-name');
                const descInput = document.getElementById('new-char-desc');
                name = nameInput.value.trim();
                desc = descInput.value.trim();
                
                if(!name) { nameInput.focus(); return; }
                
                nameInput.value = "";
                descInput.value = "";
                nameInput.focus();
            }
            
            if(!characters.some(c => c.name === name)) {
                characters.push({ name, desc });
                updateGlobalCharList();
                refreshAllCharSelects();
            }
        };

        window.removeCharacter = (idx) => {
            characters.splice(idx, 1);
            updateGlobalCharList();
            refreshAllCharSelects();
        };

        function updateGlobalCharList() {
            const list = document.getElementById('chars-list');
            if(characters.length === 0) {
                list.innerHTML = '<div class="text-xs text-gray-500 text-center py-4 italic border border-dashed border-white/5 rounded-lg" id="no-chars">Lista vacía.</div>';
                return;
            }
            list.innerHTML = '';
            characters.forEach((c, idx) => {
                const div = document.createElement('div');
                div.className = "bg-white/5 p-2 rounded-lg border border-white/10 flex justify-between items-center group animate-fade-in hover:bg-white/10 transition-colors";
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-7 h-7 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-[10px] font-bold text-white shadow-lg shadow-purple-500/20 flex-shrink-0">${c.name.charAt(0).toUpperCase()}</div>
                        <div class="flex flex-col min-w-0">
                            <span class="text-xs font-bold text-gray-200 truncate">${c.name}</span>
                            <span class="text-[9px] text-gray-500 truncate">${c.desc}</span>
                        </div>
                    </div>
                    <button onclick="removeCharacter(${idx})" class="text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-1"><i class="ph-bold ph-trash"></i></button>
                `;
                list.appendChild(div);
            });
        }

        function refreshAllCharSelects() {
            document.querySelectorAll('.block-item').forEach(block => updateCharSelectInBlock(block));
        }

        function updateCharSelectInBlock(blockElement) {
            const select = blockElement.querySelector('.char-select');
            if(!select) return;

            const currentVal = select.value;
            select.innerHTML = '<option value="none">-- Ninguno --</option>';
            
            characters.forEach(char => {
                const opt = document.createElement('option');
                opt.value = char.name;
                opt.innerText = char.name;
                select.appendChild(opt);
            });

            if(characters.some(c => c.name === currentVal)) {
                select.value = currentVal;
            }
        }

        // --- COMPILADOR FINAL ---
        window.compilePrompt = () => {
            const title = document.getElementById('g-title').value || "SIN TÍTULO";
            const genre = document.getElementById('g-genre').value || "GENÉRICO";
            const lang = document.getElementById('g-lang').value || "Español";
            const context = document.getElementById('g-context').value || "";
            
            const blocks = document.querySelectorAll('.block-item');
            
            let output = `# VIDEO PROMPT — ${genre.toUpperCase()} (${title.toUpperCase()})\n`;
            output += `Duración: ${blocks.length * 3} - ${blocks.length * 4} segundos (Aprox)  Idioma: ${lang}\n`;
            if(context) output += `Contexto: ${context}\n`;
            
            if(characters.length > 0) {
                output += `Personajes:\n`;
                characters.forEach(c => output += `- ${c.name}: ${c.desc}\n`);
            }
            
            output += `\n----------------------------------------\n\n`;

            blocks.forEach((block, index) => {
                const blockNum = index + 1;
                output += `BLOCK ${blockNum}\n\n`;

                const checks = block.querySelectorAll('.toggle-section');
                
                // Camera
                if(checks[0].checked) {
                    const type = block.querySelector('.cam-select').value;
                    const desc = block.querySelectorAll('.section-input')[0].value.trim();
                    output += `CAMERA:\n${type}${desc ? '. ' + desc : '.'}\n\n`;
                }
                // SVX
                const svxInput = block.querySelectorAll('.section-input')[1];
                if(checks[1].checked && svxInput.value.trim()) {
                    output += `SVX:\n${svxInput.value.trim()}\n\n`;
                }
                // VO (Lógica)
                if(checks[2].checked) {
                    const charName = block.querySelector('.char-select').value;
                    const langVal = block.querySelector('.lang-select').value;
                    const accentVal = block.querySelector('.accent-select').value;
                    const textVal = block.querySelector('.vo-input').value.trim();

                    if(textVal) {
                        output += `VO:\n`;
                        if(charName !== 'none') {
                            output += `${charName.toUpperCase()}`;
                            let meta = [];
                            if(langVal !== 'none') meta.push(langVal);
                            if(accentVal !== 'none') meta.push(accentVal);
                            if(meta.length > 0) output += ` (${meta.join(", ")})`;
                            output += `: `;
                        }
                        output += `—${textVal}\n\n`;
                    }
                }
                // Transition
                if(checks[3].checked) {
                    const type = block.querySelector('.trans-select').value;
                    const desc = block.querySelectorAll('.section-input')[3].value.trim(); // Index 3 is Transition extra detail
                    output += `TRANSITION:\n${type}${desc ? '. ' + desc : '.'}\n\n`;
                }

                output += `----------------------------------------\n\n`;
            });

            document.getElementById('final-output').value = output;
        };

        window.copyOutput = () => {
            const txt = document.getElementById('final-output').value;
            navigator.clipboard.writeText(txt);
        };

        // --- AI INTEGRATION (GEMINI 2.5 FLASH LITE) ---
        async function callGemini(prompt) {
            if(!currentApiKey) {
                toggleSettings();
                return null;
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${currentApiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                
                if (data.error) {
                    console.error("API Error:", data.error);
                    alert(`Error API: ${data.error.message}`);
                    return null;
                }
                
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) {
                console.error(e);
                alert("Error conectando con Gemini API");
                return null;
            }
        }

        // --- 1. GENERAR PERSONAJE CON IA ---
        window.generateAICharacter = async () => {
            const idea = document.getElementById('ai-char-idea').value;
            const btn = document.getElementById('btn-gen-char');
            
            if(!idea) {
                alert("Escribe una idea primero.");
                return;
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin"></i> Creando...`;
            btn.disabled = true;

            const prompt = `
                You are a creative character designer. Based on this idea: "${idea}", create a unique character.
                Return ONLY valid JSON: { "name": "Creative Name", "desc": "Visual description (age, clothes, vibe)" }.
                Do NOT output markdown code blocks. Just the raw JSON string.
            `;

            const result = await callGemini(prompt);
            
            if(result) {
                try {
                    const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(cleanJson);
                    addCharacter(data.name, data.desc);
                    document.getElementById('ai-char-idea').value = ""; // Limpiar
                } catch(e) { console.error("Error AI Character", e); }
            }
            btn.innerHTML = originalText;
            btn.disabled = false;
        };

        // --- 2. MEJORAR DIÁLOGOS ---
        window.improveDialogues = async () => {
            const blocks = document.querySelectorAll('.block-item');
            if(blocks.length === 0) return;

            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Mejorando diálogos...";

            const dialogues = [];
            blocks.forEach((b, i) => {
                const text = b.querySelector('.vo-input').value;
                const char = b.querySelector('.char-select').value;
                dialogues.push({ index: i, text: text, char: char });
            });

            // Lógica de tiempo
            const totalBlocks = blocks.length;
            const isShort = totalBlocks <= 3; 
            const durationText = isShort ? "10 seconds (3 blocks)" : "15 seconds (5 blocks)";

            const prompt = `
                Act as a Screenplay Dialogue Doctor.
                Total Duration: ${durationText}.
                Current Dialogues: ${JSON.stringify(dialogues)}
                
                CRITICAL INSTRUCTION:
                The total duration is strictly limited.
                - 3 blocks = ~3.3 seconds per block.
                - 5 blocks = ~3 seconds per block.
                
                Task: Improve the wording to be natural and professional in Spanish.
                Constraint: KEEP DIALOGUES EXTREMELY SHORT AND PUNCHY to fit the time constraints.
                If the input dialogue is empty, leave it empty string.
                
                Return ONLY valid JSON array of strings: ["Dialogue 1", "Dialogue 2", ...]
                No markdown formatting.
            `;

            const result = await callGemini(prompt);
            
            if(result) {
                try {
                    const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const newDialogues = JSON.parse(cleanJson);
                    blocks.forEach((b, i) => {
                        if(newDialogues[i]) b.querySelector('.vo-input').value = newDialogues[i];
                    });
                    compilePrompt();
                } catch(e) { console.error("Error parsing AI", e); }
            }
            document.getElementById('loading-overlay').classList.add('hidden');
        };

        // --- 3. AUTO-RELLENAR IA (GENERAL) ---
        window.fillWithAI = async () => {
            const title = document.getElementById('g-title').value;
            const context = document.getElementById('g-context').value;
            
            if(characters.length < 2) {
                alert("⚠️ Se necesitan mínimo 2 personajes en el reparto.");
                return;
            }
            if(!title || !context) {
                alert("Completa Título y Contexto primero.");
                return;
            }

            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Escribiendo escena completa...";

            const currentBlocksCount = document.querySelectorAll('.block-item').length || 3;
            const charList = characters.map(c => c.name).join(", ");
            const durationText = currentBlocksCount <= 3 ? "10 seconds" : "15 seconds";

            const prompt = `
                You are a Video Script Generator. Create a script JSON for ${title}.
                Context: ${context}. 
                Characters available: ${charList}.
                Language: Spanish.
                Create EXACTLY ${currentBlocksCount} blocks.
                Target Duration: ${durationText}.

                CRITICAL: Keep dialogues short to fit the ${durationText} limit.

                Structure MUST be a valid JSON array of objects:
                [
                    { 
                        "cameraType": "WIDE SHOT", "camera": "...", 
                        "svx": "...", 
                        "vo": "Dialogue text only...", "char": "ExactNameFromList",
                        "transType": "Straight Cut", "transition": "..."
                    }
                ]
                
                Return ONLY JSON. No markdown.
            `;

            const result = await callGemini(prompt);
            
            if(result) {
                try {
                    const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(cleanJson);
                    
                    document.getElementById('blocks-container').innerHTML = '';
                    data.forEach(blockData => createBlockDOM(blockData));
                    updateBlockNumbers();
                    compilePrompt();

                } catch (e) { alert("Error en formato IA."); }
            }
            document.getElementById('loading-overlay').classList.add('hidden');
        };

        // --- 4. GENERAR RANDOM (ESPAÑOL) ---
        window.generateRandomPrompt = async () => {
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Creando historia aleatoria...";

            const prompt = `
                Generate a COMPLETE RANDOM video script prompt.
                1. Invent a Title and Genre.
                2. Invent a Context.
                3. Invent 2 Characters (Name and brief desc).
                4. Create 5 Blocks of script (15s limit).
                CRITICAL: The dialogues (vo) MUST be in SPANISH and very short.
                
                Return JSON structure:
                {
                    "title": "...", "genre": "...", "context": "...",
                    "characters": [ {"name": "...", "desc": "..."}, ... ],
                    "blocks": [
                        { "cameraType": "...", "camera": "...", "svx": "...", "vo": "Spanish dialogue...", "char": "Name", "transType": "...", "transition": "..." },
                        ...
                    ]
                }
                Return ONLY JSON. No markdown.
            `;

            const result = await callGemini(prompt);

            if(result) {
                try {
                    const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(cleanJson);
                    
                    document.getElementById('g-title').value = data.title;
                    document.getElementById('g-genre').value = data.genre;
                    document.getElementById('g-context').value = data.context;
                    
                    if(data.characters) data.characters.forEach(c => addCharacter(c.name, c.desc));
                    
                    document.getElementById('blocks-container').innerHTML = '';
                    data.blocks.forEach(blockData => createBlockDOM(blockData));
                    
                    updateBlockNumbers();
                    compilePrompt();

                } catch(e) { console.error(e); }
            }
            document.getElementById('loading-overlay').classList.add('hidden');
        };

    </script>
</body>
</html>
